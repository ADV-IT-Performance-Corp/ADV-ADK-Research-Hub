---
name: CI Validate O3 Repo v3.5.7

'on':
  pull_request:
  push:
    branches:
      - master
    paths:
      - 'docs/**'
      - '.github/workflows/**'
      - '!docs/legacy/**'  # Exclude legacy files from triggering CI

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Prepare environment
        run: bash scripts/setup_env.sh

      - name: Validate commit message prefix
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%s)
          echo "Latest commit message: $COMMIT_MSG"
          if ! echo "$COMMIT_MSG" | grep -Eq '^(feat|fix|chore|docs|refactor|test|build|ci|perf|style|revert):'; then
            echo "❌ Commit message must start with an approved prefix"
            exit 1
          fi
          echo "✅ Commit message prefix check passed"

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Cache node modules
        uses: actions/cache@v3
        with:
          path: |
            ~/.npm
            node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm ci --omit=optional

      # jq and yamllint installed via scripts/setup_env.sh

      - name: Lint Markdown files
        run: npx markdownlint-cli2 "docs/**/*.md" "!docs/legacy/**"

      - name: Validate JSON files
        run: |
          echo "Validating JSON files..."
          jq . docs/source_index.json > /dev/null
          jq . docs/meta/prompt_genome.json > /dev/null
          jq . docs/meta/meta_evaluation.json > /dev/null

      - name: Validate YAML files
        run: |
          echo "Validating YAML files..."
          CONFIG='{ extends: default, rules: {line-length: {max: 120, allow-non-breakable-inline-mappings: true}} }'
          find . -path ./node_modules -prune -o \( \
            -name '*.yaml' -o -name '*.yml' \) -print0 | xargs -0 yamllint -d "$CONFIG"

      - name: Check for TODO, Coming soon, or placeholder
        run: |
          echo "Checking for incomplete work..."
          if grep -RniE 'TODO:|Coming soon|placeholder' docs/ --include="*.md" --include="*.yaml" \
            --include="*.yml" --exclude-dir=legacy; then
            echo "❌ Detected incomplete work. Please resolve before merging."
            exit 1
          fi

      - name: Validate Required Files Exist
        run: |
          echo "Checking required files..."
          REQUIRED_FILES=(
            "docs/prompt/prompt_kernel_v3.5.md"
            "docs/meta/prompt_evolution_log/v3.5.yaml"
            "docs/meta/meta_evaluation.json"
            "docs/meta/prompt_genome.json"
            "docs/source_index.json"
            "README.md"
            "CHANGELOG.md"
            "tests/golden_prompts/test_prompt_coordinator.md"
            "tests/golden_prompts/test_memory_reflection.md"
            "tests/golden_prompts/test_kpi_optimization.md"
          )

          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo "❌ Missing required file: $file"
              exit 1
            else
              echo "✅ Found: $file"
            fi
          done

      - name: Check Version Consistency
        run: |
          echo "Checking version consistency..."
          VERSION_IN_README=$(grep -oP 'version-\K[0-9]+\.[0-9]+\.[0-9]+' README.md | head -1)
          VERSION_IN_CHANGELOG=$(grep -oP '## \[v\K[0-9]+\.[0-9]+\.[0-9]+' CHANGELOG.md | head -1)

          if [ "$VERSION_IN_README" != "$VERSION_IN_CHANGELOG" ]; then
            echo "❌ Version mismatch between README ($VERSION_IN_README) and CHANGELOG ($VERSION_IN_CHANGELOG)"
            exit 1
          else
            echo "✅ Version $VERSION_IN_README is consistent across files"
          fi

      - name: Validate Golden Prompts
        run: bash scripts/validate_golden_prompts.sh


      - name: Refresh Link Cache
        run: python3 scripts/refresh_link_cache.py

      - name: Offline Link Check
        run: |
          bash scripts/offline_link_check.sh
          test -f docs/performance_marketing/reforge_growth_loops.md
          test -f docs/legacy/prompt/prompt_kernel_v3.4.md
          test -f docs/meta/prompt_genome.json

      - name: Prompt Genome Version Consistency
        run: |
          version=$(jq -r '.versions[] | select(.tag=="v3.4")' docs/meta/prompt_genome.json)
          if [ -z "$version" ]; then
            echo "Missing v3.4 entry in prompt genome."
            exit 1
          fi

      - name: Verify version consistency across files
        run: |
          echo "Checking prompt_version consistency..."
          FILE_VERSION=$(tr -d '[:space:]' < VERSION)
          SETTINGS_VERSION=$(grep -oP '^prompt_version:\s*\K[0-9]+\.[0-9]+\.[0-9]+' config/settings.yaml)
          if [ "$SETTINGS_VERSION" != "$FILE_VERSION" ]; then
            echo "❌ prompt_version mismatch: settings.yaml ($SETTINGS_VERSION) vs VERSION ($FILE_VERSION)"
            exit 1
          fi

          ACTIVE_COUNT=$(jq -r '.prompt_genome.prompts[] | select(.status=="active") | .id' \
            docs/meta/prompt_genome.json | grep -c "v$FILE_VERSION" || true)
          if [ "$ACTIVE_COUNT" -eq 0 ]; then
            echo "❌ No active prompt genome entry matches VERSION $FILE_VERSION"
            exit 1
          fi

          CORE_VERSION=$(jq -r '.sources[] | select(.type=="core") | .version' docs/source_index.json | head -1)
          if [ "$CORE_VERSION" != "$FILE_VERSION" ]; then
            echo "❌ Core source version mismatch: docs/source_index.json ($CORE_VERSION) vs VERSION ($FILE_VERSION)"
            exit 1
          fi

          README_VERSION=$(grep -oP 'Golden Prompts \(v\K[0-9]+\.[0-9]+\.[0-9]+' \
            tests/golden_prompts/README.md | head -1)
          if [ "$README_VERSION" != "$FILE_VERSION" ]; then
            echo "❌ Golden Prompts README version ($README_VERSION) does not match VERSION ($FILE_VERSION)"
            exit 1
          fi

          echo "✅ All versions match $FILE_VERSION"

      - name: Verify evaluation_results version matches VERSION
        run: |
          echo "Checking evaluation_results.json version..."
          JSON_VERSION=$(jq -r '.version' docs/meta/evaluation_results.json)
          FILE_VERSION=$(tr -d '[:space:]' < VERSION)
          if [ "$JSON_VERSION" != "$FILE_VERSION" ]; then
            echo "❌ evaluation_results.json version ($JSON_VERSION) does not match VERSION ($FILE_VERSION)"
            exit 1
          else
            echo "✅ evaluation_results.json version matches VERSION"
          fi

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Cache pip
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
          pip install -e .

      - name: Run flake8
        run: flake8

      - name: Run black check
        run: black --check .

      - name: Run mypy
        run: mypy o3research


      - name: Run unit tests with coverage
        run: |
          coverage run -m pytest
          coverage xml
          coverage report --fail-under=80

      - name: Update evaluation results
        run: python scripts/generate_evaluation.py tests/sample_metrics.json
