name: CI Validate O3 Repo

on:
  pull_request:
  push:
    branches:
      - master

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:

      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install markdownlint-cli2
        run: npm install -g markdownlint-cli2

      - name: Run Markdown Lint
        run: markdownlint-cli2 docs/**/*.md

      - name: Validate JSON files
        run: |
          jq . docs/source_index.json > /dev/null
          jq . docs/meta/prompt_genome.json > /dev/null

      - name: Check for TODO or Coming soon
        run: |
          if grep -RniE 'TODO:|Coming soon' docs/; then
            echo "❌ Detected incomplete work. Please resolve before merging."
            exit 1
          fi

      - name: Broken link check (basic)
        run: |
          grep -rEo 'https?://[^") >]+' docs/ | while read -r url; do
            curl -s --head --request GET "$url" | grep "200 OK" > /dev/null || {
              echo "Broken link: $url"
              exit 1
            }
          done

      - name: Check Required Files
        run: |
          test -f docs/performance_marketing/neurogym_neuromarketing.md
          test -f docs/performance_marketing/reforge_growth_loops.md
          test -f docs/prompt/prompt_kernel_v3.4.md
          test -f docs/meta/prompt_genome.json

      - name: Prompt Genome Version Consistency
        run: |
          version=$(jq -r '.versions[] | select(.tag=="v3.4")' docs/meta/prompt_genome.json)
          if [ -z "$version" ]; then
            echo "Missing v3.4 entry in prompt genome."
            exit 1
          fi
